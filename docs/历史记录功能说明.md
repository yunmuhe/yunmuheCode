# 历史记录功能说明

## 问题分析

历史记录没有显示的原因是：
1. 历史记录存储在 Flask 的 **session** 中
2. Session 是基于浏览器 Cookie 的
3. 前端请求需要启用 `withCredentials` 才能发送和接收 Cookie

## 已修复

### 1. 前端配置 ✅
在 `common/api.ts` 中添加了 `withCredentials: true`：
```typescript
uni.request({
    url: `${BASE_URL}${url}`,
    method,
    data,
    withCredentials: true, // 启用 credentials 以支持 session
    // ...
});
```

### 2. 后端配置 ✅
后端已经配置了 CORS 支持 credentials：
```python
CORS(app, resources={r"/*": {"origins": "*"}}, supports_credentials=True)
```

## 使用说明

### 历史记录的工作原理

1. **生成姓名时自动保存**
   - 每次成功生成姓名后，系统会自动将记录保存到 session
   - 记录包含：描述、生成数量、时间、生成的姓名列表

2. **查看历史记录**
   - 进入"历史记录"页面
   - 系统会自动加载当前会话的历史记录
   - 支持按时间分组（今天、昨天、更早）

3. **搜索和筛选**
   - 可以搜索描述内容
   - 可以按时间范围筛选（今天、近7天、近30天、全部）
   - 可以按时间或数量排序

4. **展开查看详情**
   - 点击历史记录项可以展开
   - 查看该次生成的所有姓名

## 测试步骤

### 1. 刷新前端页面
```bash
# 在浏览器中按 Ctrl+F5 强制刷新
# 或在 HBuilderX 中重新运行项目
```

### 2. 生成一些姓名
1. 进入"生成姓名"页面
2. 输入描述，例如："一个勇敢的战士"
3. 点击发送按钮
4. 等待生成完成
5. 重复几次，生成不同的姓名

### 3. 查看历史记录
1. 进入"历史记录"页面（底部导航栏）
2. 应该能看到刚才生成的记录
3. 点击记录可以展开查看详情

## 预期结果

### 生成姓名后
- ✅ 历史记录自动保存
- ✅ 不需要手动操作

### 历史记录页面
- ✅ 显示所有生成记录
- ✅ 按时间分组显示
- ✅ 显示描述和生成数量
- ✅ 点击可展开查看所有姓名
- ✅ 支持搜索和筛选

## 注意事项

### Session 的特性

1. **基于浏览器会话**
   - 历史记录存储在当前浏览器会话中
   - 关闭浏览器后会清空
   - 不同浏览器之间不共享

2. **最大存储量**
   - 最多保存 200 条记录
   - 超过后会自动删除最旧的记录

3. **隐私保护**
   - 历史记录不会上传到服务器
   - 只存储在本地浏览器中
   - 保护用户隐私

### 如果历史记录仍然不显示

#### 检查 Cookie 设置
1. 打开浏览器开发者工具（F12）
2. 进入 Application → Cookies
3. 查看是否有 `session` Cookie
4. 如果没有，检查浏览器是否禁用了 Cookie

#### 检查网络请求
1. 打开浏览器开发者工具（F12）
2. 进入 Network 标签
3. 生成一次姓名
4. 查看 `/generate` 请求的响应头
5. 应该包含 `Set-Cookie: session=...`

#### 检查历史记录请求
1. 进入历史记录页面
2. 查看 `/history/list` 请求
3. 请求头应该包含 `Cookie: session=...`
4. 响应应该包含历史记录数据

## 示例数据

### 生成姓名后的历史记录格式
```json
{
  "id": "h_1763563000123",
  "description": "一个勇敢的战士，充满正义感",
  "count": 3,
  "time": "2025-11-19T22:36:40.123456",
  "names": ["张勇毅", "陈正义", "王战辉"]
}
```

### 历史记录列表响应
```json
{
  "success": true,
  "page": 1,
  "page_size": 10,
  "total": 5,
  "items": [
    {
      "id": "h_1763563000123",
      "description": "一个勇敢的战士",
      "count": 3,
      "time": "2025-11-19T22:36:40",
      "names": ["张勇毅", "陈正义", "王战辉"]
    }
  ]
}
```

## 未来改进建议

### 持久化存储
如果需要长期保存历史记录，可以考虑：
1. 使用数据库存储（SQLite、MySQL等）
2. 使用本地存储（localStorage）
3. 添加用户账号系统

### 导出功能
可以添加：
1. 导出为 JSON 文件
2. 导出为 Excel 文件
3. 分享历史记录

---

**修复完成时间**：2025-11-19
**修复人员**：Claude Code
