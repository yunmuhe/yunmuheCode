# 用例规约文档

## UC1: 生成姓名

### 基本信息
- **用例ID**: UC1
- **用例名称**: 生成姓名
- **参与者**: 普通用户、前端应用
- **前置条件**:
  - 系统正常运行
  - 至少一个AI平台可用
- **后置条件**:
  - 返回生成的姓名列表
  - 记录生成历史
  - 缓存结果（如启用）

### 主要流程

1. 用户输入角色描述（如"聪明可爱的女孩"）
2. 用户选择生成参数（可选）：
   - 文化风格（chinese_modern/chinese_traditional等）
   - 性别（male/female/neutral）
   - 年龄段（child/adult/elder）
   - 生成数量（1-20个）
   - 指定姓氏（可选）
   - 指定朝代（可选，仅古典风格）
   - 首选AI平台（可选）
3. 系统验证输入参数
4. 系统检查缓存
5. 如缓存未命中：
   - 构建提示词
   - 从语料库获取示例增强提示词
   - 调用AI平台API
   - 解析响应结果
   - 存入缓存
6. 系统后处理姓名列表：
   - 去重
   - 格式化
   - 添加唯一ID
7. 系统记录生成历史
8. 返回姓名列表给用户

### 扩展流程

**3a. 参数验证失败**
- 3a1. 系统返回错误信息
- 3a2. 提示用户修正参数
- 用例结束

**5a. API调用失败**
- 5a1. 系统自动切换到下一个可用API
- 5a2. 重试调用
- 5a3. 如所有API都失败，返回错误信息
- 用例结束

**5b. API响应超时**
- 5b1. 系统等待最多60秒
- 5b2. 超时后自动降级到下一个API
- 返回步骤5

### 特殊需求

- **性能**: 缓存命中时响应时间<50ms，API调用2-4秒
- **可用性**: 支持自动降级，至少一个API可用即可服务
- **容量**: 支持并发50+请求/秒
- **安全性**: API密钥加密存储，不在日志中输出

### 补充说明

**输入示例**:
```json
{
  "description": "聪明可爱的女孩",
  "count": 5,
  "cultural_style": "chinese_modern",
  "gender": "female",
  "age": "child",
  "preferred_api": "aliyun",
  "use_cache": true
}
```

**输出示例**:
```json
{
  "success": true,
  "names": [
    {
      "id": "name_1737012345_1",
      "name": "李思语",
      "meaning": "思维活跃，语言天赋出众",
      "source": "ai_generated",
      "features": {
        "surname": "李",
        "given_name": "思语",
        "pinyin": "lǐ sī yǔ"
      }
    }
  ],
  "api_name": "aliyun",
  "model": "qwen-max",
  "cache_hit": false,
  "generation_time": 2.3
}
```

---

## UC2: 获取可用选项

### 基本信息
- **用例ID**: UC2
- **用例名称**: 获取可用选项
- **参与者**: 普通用户、前端应用
- **前置条件**: 系统正常运行
- **后置条件**: 返回系统支持的所有选项

### 主要流程

1. 用户请求获取可用选项
2. 系统返回以下信息：
   - 支持的文化风格列表
   - 支持的性别选项
   - 支持的年龄段选项
   - 可用的AI平台列表
   - 生成数量范围
   - 支持的朝代列表（古典风格）

### 输出示例

```json
{
  "cultural_styles": [
    {"value": "chinese_modern", "label": "中文现代"},
    {"value": "chinese_traditional", "label": "中文传统"},
    {"value": "chinese_classic", "label": "中文古典"},
    {"value": "western", "label": "西方风格"},
    {"value": "japanese", "label": "日式风格"},
    {"value": "fantasy", "label": "奇幻风格"}
  ],
  "genders": [
    {"value": "male", "label": "男性"},
    {"value": "female", "label": "女性"},
    {"value": "neutral", "label": "中性"}
  ],
  "ages": [
    {"value": "child", "label": "儿童"},
    {"value": "adult", "label": "成人"},
    {"value": "elder", "label": "长者"}
  ],
  "available_apis": ["aliyun", "siliconflow", "openai"],
  "count_range": {"min": 1, "max": 20},
  "dynasties": ["先秦", "秦", "汉", "晋", "南北朝", "隋", "唐", "宋", "元", "明", "清"]
}
```

---

## UC3: 查看生成历史

### 基本信息
- **用例ID**: UC3
- **用例名称**: 查看生成历史
- **参与者**: 普通用户
- **前置条件**: 用户已有生成记录
- **后置条件**: 显示历史记录列表

### 主要流程

1. 用户请求查看历史记录
2. 用户可选择过滤条件：
   - 时间范围
   - 文化风格
   - 性别
3. 系统查询历史记录
4. 系统返回记录列表（分页）
5. 用户可查看详细信息

### 扩展流程

**UC3.1: 搜索历史记录**
- 用户输入关键词
- 系统在历史记录中搜索匹配的姓名或描述
- 返回搜索结果

---

## UC5-UC7: 收藏管理

### UC5: 添加收藏
- 用户选择喜欢的姓名
- 系统保存到收藏列表
- 返回成功提示

### UC6: 查看收藏列表
- 用户请求查看收藏
- 系统返回收藏的姓名列表
- 支持按时间/风格排序

### UC7: 删除收藏
- 用户选择要删除的收藏
- 系统确认删除
- 从收藏列表移除

---

## UC8: 健康检查

### 基本信息
- **用例ID**: UC8
- **用例名称**: 健康检查
- **参与者**: 开发者、监控系统
- **前置条件**: 无
- **后置条件**: 返回系统健康状态

### 主要流程

1. 发送GET请求到 /health
2. 系统检查：
   - 服务运行状态
   - 数据库连接
   - 缓存可用性
   - API适配器状态
3. 返回健康状态报告

### 输出示例

```json
{
  "status": "healthy",
  "timestamp": "2025-01-16T10:30:00Z",
  "checks": {
    "database": "ok",
    "cache": "ok",
    "adapters": {
      "aliyun": "ok",
      "siliconflow": "ok",
      "openai": "error"
    }
  },
  "uptime": 86400
}
```

---

## UC9: 清除缓存

### 基本信息
- **用例ID**: UC9
- **用例名称**: 清除缓存
- **参与者**: 开发者
- **前置条件**: 具有管理权限
- **后置条件**: 缓存被清空

### 主要流程

1. 开发者发送清除缓存请求
2. 系统确认操作
3. 系统清空DiskCache
4. 返回清除结果统计

### 使用场景

- 测试新的提示词模板
- 释放磁盘空间
- 强制重新生成结果
- 修复缓存数据错误

---

## UC11: 配置API密钥

### 基本信息
- **用例ID**: UC11
- **用例名称**: 配置API密钥
- **参与者**: 开发者、系统管理员
- **前置条件**: 具有系统访问权限
- **后置条件**: API密钥配置生效

### 主要流程

1. 管理员编辑 .env 文件
2. 添加或更新API密钥：
   ```
   ALIYUN_API_KEY=sk-xxx
   SILICONFLOW_API_KEY=sk-yyy
   OPENAI_API_KEY=sk-zzz
   ```
3. 重启服务使配置生效
4. 系统加载新配置
5. 验证API密钥有效性

### 安全要求

- API密钥不得提交到版本控制
- 使用环境变量存储
- 日志中不输出完整密钥
- 定期轮换密钥

---

## UC14: 维护语料库

### 基本信息
- **用例ID**: UC14
- **用例名称**: 维护语料库
- **参与者**: 开发者
- **前置条件**: 具有数据库访问权限
- **后置条件**: 语料库数据更新

### 主要流程

1. 准备新的姓名数据（CSV格式）
2. 运行导入脚本：
   ```bash
   cd data
   python convert_csv_to_sqlite.py
   ```
3. 系统验证数据格式
4. 导入数据到SQLite
5. 更新索引
6. 验证数据完整性

### 数据格式要求

**chinese_names表**:
```csv
name,gender,frequency
张伟,男,1000
李娜,女,950
```

**ancient_names表**:
```csv
name,dynasty,gender
李白,唐,男
武则天,唐,女
```

### 维护建议

- 定期备份数据库
- 增量更新而非全量替换
- 验证数据质量
- 监控数据库大小（当前179MB）
